# 目的
### WEB三層構造を完成させる。
<br/>
<br/>



# 概要
### 1. WEBサーバ構築
### 2. APサーバ構築
### 3. php動作確認(ブラウザ)
### 4. DBサーバ構築
### 5. WordPressインストール(WEBサーバ,APサーバ)
### 6. DirectoryIndex変更(WEBサーバ)
### 7. WordPress動作確認(ブラウザ)
<br/>
<br/>




# 1. WEBサーバ構築
### Apacheインストール
```bash
# ssh接続
# ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@{WEBサーバのパブリックIP}
ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@52.195.187.63


# すべてのソフトウェアパッケージが最新の状態であることを確認する
sudo dnf upgrade -y


# Apacheインストール
# mod_proxy_fcgiは、httpd標準でインストールされるため指定不要
sudo dnf install -y httpd


# Apache 起動
sudo systemctl enable httpd
sudo systemctl start httpd


# PHP を AP に転送する設定
sudo vi /etc/httpd/conf.d/php-fpm.conf
------------------------------------------------
<FilesMatch \.php$>
    // SetHandler "proxy:fcgi://APサーバのプライベートIP:9000"
    SetHandler "proxy:fcgi://172.31.3.175:9000"
</FilesMatch>
------------------------------------------------


# Apache 再起動
sudo systemctl restart httpd


# Webサーバ側 SELinux 設定
sudo setsebool -P httpd_can_network_connect on
```


### PHP動作確認ファイル作成
```bash
# PHP動作確認ファイル作成（Webサーバ）
echo "<?php phpinfo(); ?>" | sudo tee /var/www/html/info.php


# 権限付与
sudo chown apache:apache /var/www/html/info.php
```
</br>
</br>





# 2. APサーバ構築
### セキュリティグループ設定
```bash
------------------------------------
# APサーバのSGに以下を追加：
Type: TCP
Port: 9000
Protocol: TCP
Source: WebサーバのSG or プライベートIP
------------------------------------
```

### PHPパッケージをインストール
```bash
# ssh接続
# ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@{APサーバのパブリックIP}
ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@13.114.0.249


# すべてのソフトウェアパッケージが最新の状態であることを確認する
sudo dnf upgrade -y


# AL2023 用の PHP パッケージをインストール
sudo dnf install -y wget php-fpm php-mysqli php-json php php-devel php-mysqlnd php-gd


# php-fpm 設定
sudo vi /etc/php-fpm.d/www.conf
------------------------------------------------
user = apache
group = apache

listen = 9000
; listen.allowed_clients = <WebサーバのプライベートIP>
listen.allowed_clients = 172.31.15.34
------------------------------------------------

# 起動
sudo systemctl enable php-fpm
sudo systemctl start php-fpm
sudo systemctl status php-fpm


# SELinux（AP側）
sudo setsebool -P httpd_can_network_connect on
```


### PHP動作確認ファイル作成
```bash
# PHP動作確認ファイル作成（Webサーバ）
echo "<?php phpinfo(); ?>" | sudo tee /var/www/html/info.php


# 権限付与
sudo chown apache:apache /var/www/html/info.php
```
</br>
</br>





# 3. php動作確認(ブラウザ)
```bash
# 動作確認
# http://<WebサーバのパブリックIP>/info.php
http://52.195.187.63/info.php


# 画面が表示されない場合、以下で調査
# Web → AP 疎通
# nc -zv <AP_IP> 9000
nc -zv 172.31.3.175 9000


# AP側で通信確認
sudo tcpdump -nn port 9000
```
</br>
</br>






# 4. DBサーバ構築
### セキュリティグループ設定
```bash
------------------------------------------------
# DBサーバのSGに以下を追加：
Type: MYSQL/Aurora
Port: 3306
Protocol: TCP
Source: APサーバのSG
------------------------------------------------
```

### MariaDB インストール
```bash
# ssh接続
# ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@{DBサーバのパブリックIP}
ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@18.183.151.18


# すべてのソフトウェアパッケージが最新の状態であることを確認する
sudo dnf upgrade -y


# MariaDB インストール
sudo dnf install -y mariadb105-server 


# MariaDB 起動
sudo systemctl start mariadb
sudo systemctl enable mariadb
sudo systemctl is-enabled mariadb
sudo systemctl status mariadb


# mysql_secure_installation 実行
sudo mysql_secure_installation


# MariaDB 再起動
sudo systemctl restart mariadb
sudo systemctl status mariadb
```

### WP用データベース・ユーザ作成
```bash
# mysql接続
mysql -u root -p


# ユーザ作成
# CREATE USER 'ユーザ名'@'APサーバのプライベートIP' IDENTIFIED BY 'ユーザのパスワード';
CREATE USER 'kurosawa'@'172.31.3.175' IDENTIFIED BY 'kurosawa';


# ユーザ確認
select user, host from mysql.user;


# DB作成
CREATE DATABASE `wordpress-db`;


# DB確認
show databases;


# DBに対するユーザアクセス権限付与
# GRANT ALL PRIVILEGES ON `DB名`.* TO "ユーザ名"@"APサーバのプライベートIP";
GRANT ALL PRIVILEGES ON `wordpress-db`.* TO "kurosawa"@"172.31.3.175";


# すべての変更を有効にするため、データベース権限をフラッシュ
FLUSH PRIVILEGES;


# mysqlログアウト
exit
```
</br>
</br>





# 5. WordPressインストール(WEBサーバ,APサーバ)
WEBサーバとAPサーバで同一手順を実施。
```bash
# ssh接続（WEBサーバ）
ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@52.195.187.63
# ssh接続（APサーバ）
ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@13.114.0.249


# wordpress インストール
wget https://wordpress.org/latest.tar.gz


# インストールパッケージを解凍します。
tar -xzf latest.tar.gz


# wp-configの編集
cp -a wordpress/wp-config-sample.php wordpress/wp-config.php
vi wordpress/wp-config.php
------------------------------------
define( 'DB_NAME', 'wordpress-db' );
define( 'DB_USER', 'kurosawa' );
define( 'DB_PASSWORD', 'kurosawa' );
# DB_HOSTは、DBサーバのプライベートIP
define( 'DB_HOST', '172.31.9.136' );
------------------------------------


# WordPressの配置場所作成
sudo mv wordpress/* /var/www/html/
sudo chown -R apache:apache /var/www/html/
sudo chmod -R 755 /var/www/html/
```
</br>
</br>




# 6. DirectoryIndex変更(WEBサーバ)
```bash
# ssh接続（WEBサーバ）
ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@18.183.12.226


# バックアップ作成
sudo cp -a /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.`date +"%Y%m%d_%H%M%S"`.bak


# topのURLの指定を変更する
# Apacheの DirectoryIndex に index.php を入れる
sudo vi /etc/httpd/conf/httpd.conf
------------------------------------
# index.phpを追加する
# ディレクトリアクセス時に返すデフォルトファイルの優先順位
DirectoryIndex index.php index.html
------------------------------------


# 設定反映
sudo systemctl restart httpd
```
</br>
</br>





# 7. WordPress動作確認(ブラウザ)
```bash
# 動作確認
# http://<WebサーバのパブリックIP>/
http://52.195.187.63/
```
</br>
</br>



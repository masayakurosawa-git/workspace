# 概要
### 1. 【EC2①】Apache + php-fpm を構築  
### 2. 【EC2②】mariadb + bind を構築
<br/>
<br/>

# 【EC2①】Apache + php-fpmを構築
## LAMP サーバーを準備する 
### 1. EC2インスタンスに接続
```bash
# パーミッション変更
chmod 600 ~/.ssh/entrycl_202601.pem

# ssh接続
ssh -i ~/.ssh/entrycl_202601.pem ec2-user@18.237.118.242
```
<br/>

### 2. すべてのソフトウェアパッケージが最新の状態であることを確認する
```bash
sudo dnf upgrade -y
```
<br/>

### 3. Apache ウェブサーバーの最新バージョンと AL2023 用の PHP パッケージをインストール
```bash
sudo dnf install -y httpd wget php-fpm php-mysqli php-json php php-devel
```
<br/>

### 5. Apache ウェブサーバーを起動
```bash
sudo systemctl start httpd
```
<br/>

### 6. Apache ウェブサーバーを自動起動するように設定
```bash
# 自動起動の設定
sudo systemctl enable httpd

# 自動起動の設定確認
sudo systemctl is-enabled httpd

# 状態確認
sudo systemctl status httpd
```
<br/>

### 7. セキュリティグループのインバウンドルールにhttp(ポート80)を追加。
以下を設定。
```bash
Type: HTTP
Port: 80
Protocol: TCP
Source: {マイIP}
```
<br/>

### 8. ドキュメントルート「/var/www/html」の所有者を root → ec2-user に変更
ec2-user (および apache グループの将来のメンバー) は、Apache ドキュメントルートでファイルを追加、削除、編集できるようになります。したがって、静的ウェブサイトや PHP アプリケーションなどのコンテンツを追加できます。

#### ユーザー (この場合は ec2-user) を apache グループに追加します。
```bash
sudo usermod -a -G apache ec2-user
```

#### ログアウトし、再度ログインして新しいグループを選択し、メンバーシップを確認します。  
a. ログアウト
```bash
exit
```

b. apache グループのメンバーシップを検証するには、インスタンスに再接続して次のコマンドを実行します。
```bash
groups
※ 実行結果に「apache」が含まれていることを確認
----------------------------------------
[ec2-user@ip-172-31-22-120 ~]$ groups
ec2-user adm wheel apache systemd-journal
[ec2-user@ip-172-31-22-120 ~]$ 
----------------------------------------
```

#### /var/www とそのコンテンツのグループ所有権を apache グループに変更します。
```bash
sudo chown -R ec2-user:apache /var/www
```

#### グループの書き込み許可を追加して、これからのサブディレクトにグループ ID を設定するには、/var/www とサブディレクトのディレクトリ許可を変更します。
```bash
sudo chmod 2775 /var/www && find /var/www -type d -exec sudo chmod 2775 {} \;
```

#### グループ書き込み許可を追加するには、/var/www とサブディレクトリのファイル許可を再帰的に変更します。
```bash
find /var/www -type f -exec sudo chmod 0664 {} \;
```
<br/>
<br/>



## LAMP サーバーをテストする
### 1. Apache ドキュメントルートで PHP ファイルを作成します。
```bash
echo "<?php phpinfo(); ?>" > /var/www/html/phpinfo.php
```
<br/>

### 2. ウェブブラウザで、作成したファイルの URL を入力します。
```bash
http://35.86.176.24/phpinfo.php
```
<br/>

### 3. phpinfo.php ファイルを削除
```bash
rm /var/www/html/phpinfo.php
```
<br/>
<br/>


## WordPress のインストール
### 1. パッケージをダウンロードしてインストール
```bash
sudo dnf install wget php-mysqlnd -y
```
<br/>

### 2. 最新の WordPress インストールパッケージをダウンロード
```bash
wget https://wordpress.org/latest.tar.gz
```
<br/>

### 3. インストールパッケージを解凍します。
```bash
tar -xzf latest.tar.gz
```
<br/>

### 4. wp-config-sample.php ファイルを wp-config.php という名前でコピーします。
※ この操作を実行すると、新しい構成ファイルが作成され、元のファイルがバックアップとしてそのまま保持されます。
```bash
cp wordpress/wp-config-sample.php wordpress/wp-config.php
```
<br/>

### 5. インストール用の値を入力します。
```diff
vi wordpress/wp-config.php
------------------------------------
// ** Database settings - You can get this info from your web host ** //
/** The name of the database for WordPress */
- define( 'DB_NAME', 'database_name_here' );
+ define( 'DB_NAME', 'wordpress-db-i' );

/** Database username */
- define( 'DB_USER', 'username_here' );
+ define( 'DB_USER', 'team-i' );

/** Database password */
- define( 'DB_PASSWORD', 'password_here' );
+ define( 'DB_PASSWORD', 'team-i' );

/** Database hostname */
- define( 'DB_HOST', 'localhost' );
+ define( 'DB_HOST', '172.31.26.2' );
------------------------------------
```
<br/>

### 6. WordPress ファイルを Apache ドキュメントルートの下に配置
```bash
cp -r wordpress/* /var/www/html/
```
<br/>

### 7. httpd.confを編集
```diff
# バックアップ作成
sudo cp -a /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.bk

# 設定変更
sudo vi /etc/httpd/conf/httpd.conf
------------------------------------
<Directory "/var/www/html">

- AllowOverride None
+ AllowOverride All

</Directory>
------------------------------------
```
<br/>

### 8. PHP グラフィック描画ライブラリを AL2023 にインストールする
```bash
# インストール
sudo dnf install php-gd

# パッケージ確認
sudo dnf list installed | grep php8.4-gd
------------------------------------
[ec2-user@ip-172-31-22-120 ~]$ sudo dnf list installed | grep php8.4-gd
php8.4-gd.x86_64                          8.4.16-1.amzn2023.0.1              @amazonlinux
[ec2-user@ip-172-31-22-120 ~]$
------------------------------------
```
<br/>
<br/>
<br/>


# 【EC2②】mariadb + bindを構築



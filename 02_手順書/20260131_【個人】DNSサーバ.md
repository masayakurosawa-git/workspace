# 目的
### 外部/内部用DNSサーバを構築し、それぞれ名前解決ができること。
<br/>
<br/>



# 概要
### 1. 外部DNSサーバ構築（Public Subnet）
### 2. 内部DNSサーバ構築（Private Subnet）
### 3. 各サーバのDNS設定
### 4. 疎通確認
<br/>
<br/>




# 1. 外部DNSサーバ構築（Public Subnet）
`Public Subnet` の DNSサーバを構築する。
### セキュリティグループ設定
```bash
------------------------------------
# 外部DNSサーバのSGに以下を追加：
Type: DNS
Port: 53
Protocol: TCP/UDP
Source: 0.0.0.0/0
------------------------------------
```


### bind インストール
```bash
# ssh接続
# ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@{WEBサーバのパブリックIP}
ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@52.195.187.63


# すべてのソフトウェアパッケージが最新の状態であることを確認する
sudo dnf upgrade -y


# Bindインストール
sudo dnf install -y bind


# named.conf 編集
sudo cp -a /etc/named.conf /etc/named.conf.`date +"%Y%m%d_%H%M%S"`.bak
sudo vi /etc/named.conf
------------------------------------------------
# options
options {
    directory "/var/named";
    allow-query { any; };
    recursion no;
    dnssec-validation no;
    listen-on port 53 { any; };
};

# ゾーン定義追加
zone "teamc.entrycl.net" IN {
    type master;
    file "teamc.entrycl.net.zone";
};
------------------------------------------------


# ゾーンファイル作成
sudo vi /var/named/teamc.entrycl.net.zone
------------------------------------------------
$TTL 60
@   IN SOA ns.teamc.entrycl.net. admin.teamc.entrycl.net. (
20260123 ; serial
3600 ; refresh
3600 ; retry
3600 ; expire
3600 ) ; minimum
)

    IN NS ns.teamc.entrycl.net.
ns  IN A  <外部DNSのElasticIP>
www IN A  <WebサーバのElasticIP>

    IN MX 10 mail.teamc.entrycl.net.
mail IN A  <WebサーバのElasticIP>
------------------------------------------------


# 権限付与
sudo chown named:named /var/named/teamc.entrycl.net.zone


# bind起動
sudo systemctl enable named
sudo systemctl start named
```
</br>
</br>





# 2. 内部DNSサーバ構築（Private Subnet）
`Private Subnet` の DNSサーバを構築する。
### セキュリティグループ設定
```bash
------------------------------------
# 内部DNSサーバのSGに以下を追加：
Type: DNS
Port: 53
Protocol: TCP/UDP
Source: VPC CIDR(VPCのネットワークアドレス)
------------------------------------
```


### bind インストール
```bash
# ssh接続
# ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@{WEBサーバのパブリックIP}
ssh -i ~/.ssh/PS_kurosawa.pem ec2-user@52.195.187.63


# すべてのソフトウェアパッケージが最新の状態であることを確認する
sudo dnf upgrade -y


# Bindインストール
sudo dnf install -y bind


# named.conf 編集
sudo cp -a /etc/named.conf /etc/named.conf.`date +"%Y%m%d_%H%M%S"`.bak
sudo vi /etc/named.conf
------------------------------------------------
# options
options {
    directory "/var/named";
    allow-query { 10.0.0.0/16; }; # vpcのネットワーク
    recursion yes;
    listen-on port 53 { any; };
};

# ゾーン定義追加
zone "kurosawa.local" IN {
    type master;
    file "kurosawa.local.zone";
};

------------------------------------------------


# ゾーンファイル作成
sudo vi /var/named/kurosawa.local.zone
------------------------------------------------
$TTL 60
@ IN SOA ns.wp.local. root.wp.local. (
20260123 ; serial
3600 ; refresh
3600 ; retry
3600 ; expire
3600 ) ; minimum

        IN NS ns.wp.local.

ns       IN A 10.0.0.96
ap-01    IN A 10.0.0.96
ap-02    IN A 10.0.0.120
web-01   IN A 10.0.0.26
db-01    IN A 10.0.0.164
------------------------------------------------


# bind起動
sudo systemctl enable named
sudo systemctl start named
```
</br>
</br>






# 3. 各サーバのDNS設定（Private Subnet）
`Private Subnet` の DNSサーバの設定を変更する。
### ① VPC内部サーバ（Web / AP / DB）
```bash
sudo vi /etc/resolv.conf
------------------------------------
# 名前解決の向き先を「内部DNS」に設定
nameserver <内部DNSのPrivateIP>
------------------------------------
```

### ② 外部DNSサーバ自身
```bash
sudo vi /etc/resolv.conf
------------------------------------
# 外部DNSは「外向け名前解決」が役割
nameserver 8.8.8.8
nameserver 1.1.1.1
------------------------------------
```

### ③ 内部DNSサーバ自身
```bash
sudo vi /etc/resolv.conf
------------------------------------
# 自分のゾーンは自分で引く
nameserver 127.0.0.1
nameserver 8.8.8.8
------------------------------------
```
</br>
</br>




# 4. 疎通確認
### 外部DNS確認
```bash
dig teamc.entrycl.net
```


### 内部DNS確認
```bash
dig web.kurosawa.local
```




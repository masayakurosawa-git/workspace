# 概要
### 1. postfix を構築する
### 2. dovecot を構築する
<br/>
<br/>


# 設定ファイルチェック
###  Postfixの設定
 - /etc/postfix/main.cf

### Dovecotの設定
 - /etc/dovecot/dovecot.conf
 - /etc/dovecot/conf.d/10-ssl.conf
 - /etc/dovecot/conf.d/10-auth.conf
<br/>
<br/>
<br/>


# 1. Postfix を構築する
## セキュリティグループにルール追加
以下ルールを追加。
```bash
タイプ: SMTP
プロトコル: TCP
ポート範囲: 25
ソース: 0.0.0.0/0

※ OutlookのIPが不明のため、フルオープン
```
</br>


## Postfixのインストール
```bash
# EC2インスタンスに接続
ssh -i ~/.ssh/CL_kurosawa_key.pem ec2-user@18.246.237.98

# ユーザスイッチ
sudo su -

# インストール
dnf install postfix

# 起動
systemctl start postfix

# 状態確認
systemctl status postfix
ps -ef | grep postfix
netstat -ln | grep 25

# メール送信コマンドインストール
dnf install mailx
※ このコマンドでメールを操作することが可能。
```
</br>


## Postfixの設定
```bash
# バックアップ作成
cp -a /etc/postfix/main.cf /etc/postfix/main.cf.`date "+%Y%m%d_%H%M%S"`.bak

# 確認
ls -l /etc/postfix/ | grep main
-----------------------------------
[root@ip-172-31-38-31 ~]# ls -l /etc/postfix/ | grep main
-rw-r--r--. 1 root root 29709 Jan 16  2024 main.cf
-rw-r--r--. 1 root root 29709 Jan 16  2024 main.cf.20260123_013804.bak
-rw-r--r--. 1 root root 29470 Jan 16  2024 main.cf.proto
[root@ip-172-31-38-31 ~]# 
-----------------------------------


# コメントアウトの削除（見づらいため）
grep -v ^# /etc/postfix/main.cf | cat -s > /tmp/main.cf
※ cat -s オプションは複数空白行を縮める

# 確認
view /tmp/main.cf

# /tmp/main.cf を /etc/postfix/ にコピー
cp /tmp/main.cf /etc/postfix/main.cf


# Postfixの設定ファイルを編集
vi /etc/postfix/main.cf
-----------------------------------
↓変更
# inet_interfaces = localhost
inet_interfaces = all

# mydestination = $myhostname, localhost.$mydomain, localhost
mydestination = $mydomain, $myhostname

↓追加
# 20260126_add
myhostname = mail1.teamc.entrycl.net
mydomain = teamc.entrycl.net
myorigin = $myhostname
mynetworks = 0.0.0.0/0, 127.0.0.1
mail_spool_directory = /var/spool/mail/
-----------------------------------


# postfix を再起動
systemctl restart postfix
systemctl status postfix

```
</br>




# 2. Dovecot を構築する
## Dovecot のインストール
```bash
# インストール
dnf install dovecot
```
</br>


## Dovecot の設定
```bash
# dovecot.conf を変更
cp -a /etc/dovecot/dovecot.conf /etc/dovecot/dovecot.conf.`date "+%Y%m%d_%H%M%S"`.bak
ls -l /etc/dovecot/ | grep dovecot
vi /etc/dovecot/dovecot.conf
----------------------------------------
protocols = pop3

mail_location = maildir:/var/spool/mail/%u/
----------------------------------------


# 10-ssl.conf を修正
cp -a /etc/dovecot/conf.d/10-ssl.conf /etc/dovecot/conf.d/10-ssl.conf.`date "+%Y%m%d_%H%M%S"`.bak
ls -l /etc/dovecot/conf.d/ | grep 10-ssl
vi /etc/dovecot/conf.d/10-ssl.conf
----------------------------------------
sslをコメントアウト
ssl = required
↓
# ssl = required
----------------------------------------


# 10-auth.conf を修正
cp -a /etc/dovecot/conf.d/10-auth.conf /etc/dovecot/conf.d/10-auth.conf.`date "+%Y%m%d_%H%M%S"`.bak
ls -l /etc/dovecot/conf.d/ | grep 10-auth
vi /etc/dovecot/conf.d/10-auth.conf
----------------------------------------
disable_plaintext_auth を no に
#disable_plaintext_auth = yes
↓
disable_plaintext_auth = no
----------------------------------------


# dovecot 再起動
systemctl restart dovecot
systemctl enable dovecot
```
</br>
</br>



## メールユーザの作成
```bash
# ユーザ作成
useradd teamc -g mail -M -K MAIL_DIR=/dev/null -s /sbin/nologin

# パスワード設定
passwd teamc
```


## メール確認
```bash
# telnet のインストール（telnetでメールを確認する方法）
dnf install telnet


# ログイン
telnet localhost 110
----------------------------------------
# ユーザを入力
user teamc
+OK

# パスワードを入力
pass teamc
+OK Logged in.

# メールのリスト
list
+OK 1 messages:
1 581
.

# メールIDを指定して、開く
retr 1
+OK 581 octets

----------------------------------------

```
</br>
</br>
</br>



EIP: パブリックIPを固定化する。
IPの自動割り当てを「無効化」する。


# 概要
### 1. 要件
### 1. postfix を構築する
### 2. dovecot を構築する
<br/>
<br/>


# 要件
- ネットワーク
    - VPCを1つ、サブネットを4つ作成してください。なお、サブネットは必ずゾーンを分けてください。
    - サブネットはパブリックサブネットとプライベートサブネットに分けてください。
    - パブリックサブネットにあるサーバにはEIPを付与してください。
    - それ以外のサーバーはパブリックIPを無効にしてください。

- DNS(外部)
    - ntrycl.netから各チームサブドメインを払い出してもらう。
    （teamX.entrycl.net）
    - 顧客ごとに、払い出してもらったドメインからさらにサブドメインを払い出す。
    （例：sanma.teamX.entrycl.net, maguro.teamX.entrycl.net, shake.teamX.entrycl.net）

- DNS（内部）
    - ドメイン：wp.local
    - 各サーバ間通信はすべてホスト名で通信すること 例）web-01.wp.local

- NTP
    - 全サーバにて、構築したNTPサーバと時刻同期できるようにしてください。
    - NTPサーバの指定はホスト名で指定すること

- NFS
    - メール受信ディレクトリを共有してください。
    - Apacheのドキュメントルート用ディレクトリも共有してください。
    - 他にも共有したいディレクトリがあれば共有しましょう。
    - OS再起動後もマウントできるように設定しましょう。

- メール
    - 顧客ごとにユーザーを作成しメールアドレスを用意してください。
    例）banana@team99.entrycl.net
    - Outlookからメールを送り受信ができるようにしてください。
    - Dovecotを構築し、ユーザーごとにメールが受信できていることを確認してください。

- Web
    - Apacheを使用してください。
    - 顧客は3社ある想定で、サブドメインごとに顧客がアクセスできるようにしてください。（例）banana.team99.entrycl.net, ringo.team99.entrycl.net, tomato.team99.entrycl.net
    - [apache virtualhost 名前ベース]などで調査してみてください。

- AP
    - Wordpressをインストールしてください。
    - 冗長化してください。(Apacheのmod_proxy_balancerがヒント) → 2つ

- DB
    - Databaseは顧客ごとに3つ用意してください。
    - mariadbを使ってください。





# 環境作成
- vpc
    - Name
        - CL_teamc

    - IPv4 CIDR
        - 10.0.0.0/24


- subnet
    - public
        - teamc_web
            - 10.0.0.0/26
        - teamc_dns2
            - 10.0.0.192/26

    - private
        - teamc_ap
            - 10.0.0.64/26
        - teamc_db
            - 10.0.0.128/26



# APサーバ構築
### PHPパッケージをインストール
```bash
# ファイル転送
scp -i ~/.ssh/entrycl_202601.pem ~/.ssh/entrycl_202601.pem ec2-user@100.22.207.72:/home/ec2-user/.ssh/


# ssh接続
ssh -i ~/.ssh/entrycl_202601.pem ec2-user@52.25.234.17
ssh -i ~/.ssh/entrycl_202601.pem ec2-user@10.0.0.96


# すべてのソフトウェアパッケージが最新の状態であることを確認する
sudo dnf upgrade -y


# AL2023 用の PHP パッケージをインストール
sudo dnf install -y httpd wget php-fpm php-mysqli php-json php php-devel php-mysqlnd php-gd 

```

### WordPress のインストール
```bash
# wordpress インストール
wget https://wordpress.org/latest.tar.gz


# インストールパッケージを解凍します。
tar -xzf latest.tar.gz


# wp-configの編集
cp -a wordpress/wp-config-sample.php wordpress/wp-config.php
vi wordpress/wp-config.php
------------------------------------
define('DB_NAME', 'wordpress-db');
define('DB_USER', 'wordpress-user');
define('DB_PASSWORD', 'your_strong_password');
define('DB_HOST', '＜DBサーバのプライベートIP＞');
------------------------------------


# WordPressの配置場所作成
sudo mv wordpress/* /var/www/html/
sudo chown -R apache:apache /var/www/html/
sudo chmod -R 755 /var/www/html/


# PHP-FPM を「Webサーバから受ける設定」に変更
sudo vi /etc/php-fpm.d/www.conf
------------------------------------
; listen = /run/php-fpm/www.sock
listen = 9000

listen.allowed_clients = ＜WebサーバのプライベートIP＞

user = apache
group = apache
------------------------------------


# PHP-FPM を起動・自動起動
sudo systemctl enable php-fpm
sudo systemctl start php-fpm
sudo systemctl status php-fpm


# セキュリティグループ確認
------------------------------------
# APサーバのSGに以下を追加：
Type: TCP
Port: 9000
Protocol: TCP
Source: WebサーバのSG or プライベートIP
------------------------------------


# SELinux
sudo setsebool -P httpd_can_network_connect on


# WordPressの書き込みディレクトリ作成
sudo mkdir -p /var/www/html/wp-content/uploads
sudo chown -R apache:apache /var/www/html/wp-content
sudo chmod -R 755 /var/www/html/wp-content


# PHP動作確認（WEBサーバで実施）
echo "<?php phpinfo(); ?>" | sudo tee /var/www/html/info.php
```




### WordPressインストール(WEBサーバ)
```bash
# wordpress インストール
wget https://wordpress.org/latest.tar.gz


# インストールパッケージを解凍します。
tar -xzf latest.tar.gz


# wp-configの編集
cp -a wordpress/wp-config-sample.php wordpress/wp-config.php
vi wordpress/wp-config.php
------------------------------------
define('DB_NAME', 'wordpress-db');
define('DB_USER', 'ieyasu');
define('DB_PASSWORD', '0001');
define('DB_HOST', '10.0.0.164');
------------------------------------


# WordPressの配置場所作成
sudo mv wordpress/* /var/www/html/
sudo chown -R apache:apache /var/www/html/
sudo chmod -R 755 /var/www/html/


# PHP-FPM を「Webサーバから受ける設定」に変更
sudo vi /etc/php-fpm.d/www.conf
------------------------------------
; listen = /run/php-fpm/www.sock
listen = 9000

listen.allowed_clients = 10.0.0.26

user = apache
group = apache
------------------------------------


# PHP-FPM を起動・自動起動
sudo systemctl enable php-fpm
sudo systemctl start php-fpm
sudo systemctl status php-fpm


# SELinux
# sudo setsebool -P httpd_can_network_connect on


# WordPressの書き込みディレクトリ作成
sudo mkdir -p /var/www/html/wp-content/uploads
sudo chown -R apache:apache /var/www/html/wp-content
sudo chmod -R 755 /var/www/html/wp-content


# PHP動作確認（WEBサーバで実施）
echo "<?php phpinfo(); ?>" | sudo tee /var/www/html/info.php
```






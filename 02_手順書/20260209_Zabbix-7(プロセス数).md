# 閾値を超過したら自身のOutlookにメールが届くようにする。

## 前提
**エージェント側にmariadbがインストールされていること**</br>
**インストールしていない場合は、以下を実行する**
```bash
sudo dnf install mariadb105-server -y
sudo systemctl start mariadb
sudo systemctl enable mariadb
```

</br>
</br>


## 1. シェルスクリプト作成
**EC2接続(ZabbixServer)**
```bash
ssh -i ~/.ssh/CL_kurosawa_key.pem ec2-user@54.213.10.15
```

**rootにスイッチ**
```bash
sudo su -
```

**シェル作成**
```bash
vi /usr/local/bin/zbx_mariadb_proc_count.sh
```
```bash
#!/usr/bin/env bash
set -euo pipefail

# mariadbd / mysqld のプロセス数を返す
# -x: プロセス名完全一致（誤検知を減らす）
count=0
if command -v pgrep >/dev/null 2>&1; then
  count="$(pgrep -xc mariadbd || true)"
  if [ "$count" -eq 0 ]; then
    count="$(pgrep -xc mysqld || true)"
  fi
else
  # pgrep が無い場合のフォールバック
  count="$(ps -C mariadbd --no-headers 2>/dev/null | wc -l || true)"
  if [ "$count" -eq 0 ]; then
    count="$(ps -C mysqld --no-headers 2>/dev/null | wc -l || true)"
  fi
fi

echo "${count:-0}"
```

**権限付与**
```bash
chmod +x /usr/local/bin/zbx_mariadb_proc_count.sh
```

**動作確認**
```bash
/usr/local/bin/zbx_mariadb_proc_count.sh
```

</br>
</br>


## 2. Zabbix Agent 側に「UserParameter」を追加
**UserParameter 追加**
```bash
sudo tee /etc/zabbix/zabbix_agentd.d/userparameter_mariadb.conf > /dev/null <<'EOF'
UserParameter=mariadb.proc.count,/usr/local/bin/zbx_mariadb_proc_count.sh
EOF
```

**再起動**
```bash
sudo systemctl restart zabbix-agent
```

</br>
</br>


## 3. Zabbix サーバ側から取得できるか確認
**Zabbixサーバで実行**
```bash
#zabbix_get -s <監視対象のIP> -k mariadb.proc.count
zabbix_get -s 172.31.22.176 -k mariadb.proc.count

# 値が返ってくればOK
```

</br>
</br>


## 4. Zabbix UI で「アイテム」を作成
**アイテム作成**
```bash
データ収集
↓
ホスト
↓
（zabbix agent）
↓
アイテム
↓
作成

以下、設定を追加。
============================
名前：MariaDB process count
タイプ：Zabbix agent（agent2でも表示はだいたい同じ）
キー：mariadb.proc.count
データ型：数値（符号なし）
単位：proc（任意）
更新間隔：30s か 1m
============================
```

</br>
</br>


## 5. グラフを作成
```bash
データ収集
↓
ホスト
↓
（zabbix agent）
↓
グラフ
↓
作成

以下、設定を追加。
============================
名前：MariaDB process count
アイテム追加：MariaDB process count（さっき作ったアイテム）
（必要なら）Y軸 0〜数個くらいの見やすい範囲に調整
============================
```





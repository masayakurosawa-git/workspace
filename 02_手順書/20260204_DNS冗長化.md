# DNS 冗長化（Master / Slave）構築手順
### 1. Master側設定
### 2. Slave側設定
### 3. 転送確認
### 4. クライアント側のDNS冗長化
</br>
</br>




# 全体構成
```bash
# 以下、内部DNS想定
[Web/AP/DB]
     |
DNS1(ap-01) ← Master (10.0.0.96)
DNS2(ap-02) ← Slave  (10.0.0.120)
```
</br>
</br>




# 手順
## 1. Master側設定
```bash
# 1. zone transfer を許可
sudo vi /etc/named.conf
-----------------------------------------------------
# ゾーン定義を探す
zone "wp.local" IN {
    type master;
    file "wp.local.zone";
    allow-transfer { 10.0.0.120; }; #Slave側のプライベートIP
    allow-query { any; };
};
-----------------------------------------------------


# 2. ゾーンファイル修正
sudo vi /var/named/teamc.entrycl.net.zone
-----------------------------------------------------
# NSレコードを2台にする
@   IN NS ns1.teamc.entrycl.net.
@   IN NS ns2.teamc.entrycl.net.

ns1 IN A 35.162.193.118 #Master側のIP
ns2 IN A 52.25.234.17 #Slave側のIP
-----------------------------------------------------


# 3. named 再起動
sudo systemctl restart named
sudo systemctl enable named


# 4. 確認
sudo rndc reload
```



## 2. Slave側設定
```bash
# 1. named インストール
sudo dnf install -y bind bind-utils


# 2. slave zone 定義
sudo vi /etc/named.conf
-----------------------------------------------------
zone "wp.local" IN {
    type slave;
    file "slaves/wp.local.zone";
    masters { 10.0.0.96; };
};

# slaves ディレクトリは named が自動作成することが多い
-----------------------------------------------------


# 3. slaves ディレクトリ権限（念のため）
sudo mkdir -p /var/named/slaves
sudo chown named:named /var/named/slaves
sudo chmod 750 /var/named/slaves


# 4. named 起動
sudo systemctl start named
sudo systemctl enable named
```



## 3. 転送確認
```bash
# ゾーンファイル確認
sudo ls -l /var/named/slaves


# Slave側で確認
dig @127.0.0.1 wp.local SOA
dig @127.0.0.1 ap-01.wp.local
```



## 4. クライアント側のDNS冗長化
```bash
# 設定変更
sudo vi /etc/systemd/resolved.conf
-----------------------------------------------------
# DBサーバ、WEBサーバ、APサーバで修正
[Resolve]
DNS=10.0.0.96 10.0.0.120
-----------------------------------------------------


# 設定反映
sudo systemctl restart systemd-resolved
resolvectl status
```



## 5. フェイルオーバーテスト
```bash
# 1. Master停止
sudo systemctl stop named

# 2. 名前解決確認
dig ap-02.wp.local
nslookup db-01.wp.local


# 通れば成功。
```







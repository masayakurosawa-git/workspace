# tomcat構築手順
## サーバにログインしてrootにスイッチ
sudo su -
cd /home/ec2-user




## JDKインストール
- JDKダウンロード
Java8
wget https://corretto.aws/downloads/latest/amazon-corretto-8-x64-linux-jdk.tar.gz
ls -l amazon-corretto-8-x64-linux-jdk.tar.gz

- 解凍する
tar zxf amazon-corretto-8-x64-linux-jdk.tar.gz

- 解凍したディレクトリを移動
mv amazon-corretto-8.472.08.1-linux-x64 /opt

- javaにパスを通す
vi /root/.bash_profile
末尾に追記
------------------------------
PATH=$PATH:$HOME/bin:/opt/amazon-corretto-8.472.08.1-linux-x64/bin
------------------------------

- bash_profileを再読み込み
exit
sudo su -




## Tomcatインストール
- tomcatユーザ追加
useradd -s /sbin/nologin tomcat

- Tomcatをダウンロード
- v9.0.113
cd /home/ec2-user
wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.113/bin/apache-tomcat-9.0.113.tar.gz
ls -l apache-tomcat-9.0.113.tar.gz

- 解凍する
tar zxf apache-tomcat-9.0.113.tar.gz
mv apache-tomcat-9.0.113 /usr/local/

- 所有者とグループを変更
chown -R tomcat:tomcat /usr/local/apache-tomcat-9.0.113

- シンボリックリンクを貼る
ln -s /usr/local/apache-tomcat-9.0.113 /usr/local/tomcat

- setenv.shを作成
vi /usr/local/tomcat/bin/setenv.sh
------------------------------
#!/bin/sh
CATALINA_HOME=/usr/local/tomcat
JAVA_HOME=/opt/amazon-corretto-8.472.08.1-linux-x64
JAVA_OPTS="-Xms128m -Xmx512m"
------------------------------

- server.xmlを設定
↓設定ファイルのバックアップ。
cp -a /usr/local/tomcat/conf/server.xml /usr/local/tomcat/conf/server.xml.bk

↓自動デプロイを無効にする
vi /usr/local/tomcat/conf/server.xml

unpackWARs と autoDeploy をfalseにする。
------------------------------
<Host name="localhost"  appBase="webapps"
    unpackWARs="true" autoDeploy="true">
↓
<Host name="localhost"  appBase="webapps"
    unpackWARs="false" autoDeploy="false">
------------------------------

- 自動起動スクリプトを作成する。
vi /etc/systemd/system/tomcat.service
------------------------------
[Unit]
Description=Apache Tomcat 9
After=network.target

[Service]
User=tomcat
Group=tomcat
Type=oneshot
PIDFile=/usr/local/tomcat/tomcat.pid
RemainAfterExit=yes

ExecStart=/usr/local/tomcat/bin/startup.sh
ExecStop=/usr/local/tomcat/bin/shutdown.sh
ExecReStart=/usr/local/tomcat/bin/shutdown.sh;/usr/local/tomcat/bin/startup.sh

[Install]
WantedBy=multi-user.target
------------------------------

- パーミッション変更
chmod 755 /etc/systemd/system/tomcat.service

- 自動起動を有効化して、tomcatを起動する。・
systemctl enable tomcat
systemctl start tomcat




## Apacheのインストール
- yumをインストール
dnf install httpd

- proxyを設定
vi /etc/httpd/conf/httpd.conf
末尾に追加
------------------------------
ProxyRequests Off
ProxyPass /knowledge http://127.0.0.1:8080/knowledge
ProxyPassReverse /knowledge http://127.0.0.1:8080/knowledge
------------------------------

- 自動有効化と起動
systemctl enable httpd
systemctl start httpd


5. Javaアプリの配置
- 配置場所ディレクトリ作成
mkdir /usr/local/tomcat/webapps/knowledge
cd /usr/local/tomcat/webapps/knowledge

- アプリケーションダウンロード
wget https://github.com/support-project/knowledge/releases/download/v1.13.1/knowledge.war

- ダウンロードファイルの解凍
jar xf knowledge.war

- 不要ファイルの削除
rm knowledge.war

- アプリケーションの権限変更
cd ../
chown -R tomcat:tomcat knowledge

- tomcat再起動
systemctl restart tomcat




## セキュリティーグループ変更
インバウンドルールにポート「8080」を追加




## 動作確認
http://44.248.135.88:8080/knowledge

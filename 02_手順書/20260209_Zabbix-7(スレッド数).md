# 閾値を超過したら自身のOutlookにメールが届くようにする。

## 前提
**エージェント側にmariadbがインストールされていること**</br>
**インストールしていない場合は、以下を実行する**
```bash
sudo dnf install mariadb105-server -y
sudo systemctl start mariadb
sudo systemctl enable mariadb
```

</br>
</br>


**EC2接続(ZabbixServer)**
```bash
ssh -i ~/.ssh/CL_kurosawa_key.pem ec2-user@54.213.10.15
```

**rootにスイッチ**
```bash
sudo su -
```

</br>
</br>


## 0. 監視用ユーザーを作成
**DBユーザ作成**
```bash
mysql -uroot -p -e "
CREATE USER IF NOT EXISTS 'zbx_mon'@'localhost' IDENTIFIED BY 'StrongPass!';
GRANT PROCESS, REPLICATION CLIENT ON *.* TO 'zbx_mon'@'localhost';
FLUSH PRIVILEGES;"
```

</br>
</br>


## 1. スクリプト作成
**クレデンシャルファイル作成**
```bash
vi /etc/zabbix/.my.cnf
```
```bash
[client]
user=zbx_mon
password=StrongPass!
host=localhost
```
```bash
# 権限追加
sudo chown zabbix:zabbix /etc/zabbix/.my.cnf
sudo chmod 600 /etc/zabbix/.my.cnf
```


**スクリプト作成**
```bash
vi /usr/local/bin/zbx_mysql_threads_connected.sh
```
```bash
#!/usr/bin/env bash
set -euo pipefail

# Threads_connected を数値で返す
mysql --defaults-extra-file=/etc/zabbix/.my.cnf -N -s -e \
"SHOW GLOBAL STATUS LIKE 'Threads_connected';" \
| awk '{print $2}' | tr -d '\r' | awk 'NF{print; exit} END{if(NR==0) print 0}'
```
```bash
# 権限付与
chmod +x /usr/local/bin/zbx_mysql_threads_connected.sh
```

**動作確認**
```bash
/usr/local/bin/zbx_mysql_threads_connected.sh
```

</br>
</br>


## 2. Zabbix Agent 側に「UserParameter」を追加
**UserParameter 追加**
```bash
sudo tee /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf > /dev/null <<'EOF'
UserParameter=mysql.threads.connected,/usr/local/bin/zbx_mysql_threads_connected.sh
EOF
```

**再起動**
```bash
sudo systemctl restart zabbix-agent
```

</br>
</br>


## 3. Zabbix サーバ側から取得できるか確認
**Zabbixサーバで実行**
```bash
#zabbix_get -s <監視対象のIP> -k <UserParameter>
zabbix_get -s 172.31.22.176 -k mysql.threads.connected

# 値が返ってくればOK
```

</br>
</br>


## 4. Zabbix UI で「アイテム」を作成
**アイテム作成**
```bash
データ収集
↓
ホスト
↓
（zabbix agent）
↓
アイテム
↓
作成

以下、設定を追加。
============================
名前：MariaDB threads connected
タイプ：Zabbix agent（agent2でも表示はだいたい同じ）
キー：mysql.threads.connected
データ型：数値（符号なし）
単位：thread（任意）
更新間隔：30s か 1m
============================
```

</br>
</br>


## 5. グラフを作成
**グラフ作成**
```bash
データ収集
↓
ホスト
↓
（zabbix agent）
↓
グラフ
↓
作成

以下、設定を追加。
============================
名前：MariaDB threads connected
アイテム追加：MariaDB threads connected（さっき作ったアイテム）
（必要なら）Y軸 0〜数個くらいの見やすい範囲に調整
============================
```

</br>
</br>


## 6. テスト（スレッド数を増やす）
**スレッド増加**
```bash
#for i in {1..30}; do mysql -uroot -p"rootユーザのパスワード" -e "SELECT SLEEP(20);" >/dev/null 2>&1 & done
for i in {1..30}; do mysql -uroot -p"kurosawa" -e "SELECT SLEEP(20);" >/dev/null 2>&1 & done
```
**確認**
```bash
/usr/local/bin/zbx_mysql_threads_connected.sh
```



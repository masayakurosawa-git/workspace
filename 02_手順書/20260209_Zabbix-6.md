# 閾値を超過したら自身のOutlookにメールが届くようにする。

## 1. Postfix のインストール
**EC2接続(ZabbixServer)**
```bash
ssh -i ~/.ssh/CL_kurosawa_key.pem ec2-user@54.213.10.15
```

**rootにスイッチ**
```bash
sudo su -
```

**Postfix インストール**
```bash
dnf install postfix -y
```

**Postfix 設定**
```bash
# バックアップ作成
cp -a /etc/postfix/main.cf{,_`date "+%Y%m%d_%H%M%S"`.bak}


# コメントアウトの削除（見づらいため）
grep -v ^# /etc/postfix/main.cf | cat -s > /tmp/main.cf
※ cat -s オプションは複数空白行を縮める


# 確認
view /tmp/main.cf


# /tmp/main.cf を /etc/postfix/ にコピー
cp /tmp/main.cf /etc/postfix/main.cf


# Postfixの設定ファイルを編集
vi /etc/postfix/main.cf
-----------------------------------
# 追加
myhostname = zabbix.example.local
mydomain = example.local
myorigin = $mydomain
-----------------------------------
```

**Postfix 起動**
```bash
systemctl enable postfix
systemctl start postfix
```

</br>
</br>


## 2. Zabbix メール設定
**メール設定**
```bash
通知
↓
メディアタイプ
↓
Email
↓
以下に変更
-----------------------------------
- SMTPサーバ：127.0.0.1
# 表示したいメールアドレス
- メール：zabbix-notify@example.local
# Postfixで設定したhostnameと合わせる
- SMTP helo：zabbix.example.local
-----------------------------------
↓
更新
```

**トリガーの設定**
```bash
データ収集
↓
ホスト
↓
監視したいホストの「トリガー」リンク
↓
トリガーの作成
↓
以下のみ変更
-----------------------------------
名前：CPU High (zabbix agent)
深刻度：重度の障害
条件式：
#last(/＜監視したいホスト名＞/system.cpu.util[,system])>80
last(/zabbix agent/system.cpu.util[,system])>80
-----------------------------------
```

**アクションの設定**
```bash
通知
↓
アクション
↓
トリガーアクション
↓
アクションの作成
↓
以下を入力
-----------------------------------
名前：CPU Alert
実行条件：
    タイプ：トリガー
    トリガー：作成したトリガーを選択
-----------------------------------
↓
追加
↓
タブ「実行内容」
↓
以下のみ設定
-----------------------------------
ユーザグループに送信：Zabbix adominstrator
-----------------------------------
↓
追加
↓
追加
```

**ユーザ設定**
```bash
ユーザ
↓
ユーザ
↓
タブ「メディア」
↓
メディア追加
↓
以下を修正
-----------------------------------
タイプ：Email
送信先：＜アラートメールの送信先＞
指定した深刻度のときに使用：
    軽度の障害
    重度の障害
    致命的な障害
-----------------------------------
↓
追加
```

</br>
</br>


## 3. Agent側で負荷をかける
**EC2接続(ZabbixAgent)**
```bash
ssh -i ~/.ssh/CL_kurosawa_key.pem ec2-user@54.213.10.15
```

**4コアで負荷をかける**
```bash
yes > /dev/null &
yes > /dev/null &
yes > /dev/null &
yes > /dev/null &
```

**Zabbix確認**
```bash
最新グラフの「CPU utilization」を確認。
最新値が80%以上になっていることを確認する。
```

**アラートメール確認**
```bash
outlookでメールが届いていることを確認する。
```


**プロセスキル**
```bash
killall yes
```



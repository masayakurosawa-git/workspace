# 西上原さんへの相談
西上原さん

お疲れ様です。
CLの黒澤正哉です。
現場配属のことでご相談があり、連絡いたしました。
急いではいないため、西上原さんのお時間に余裕があるときにお話しできれば幸いです。
よろしくお願いいたします。

黒澤正哉

# ストレージ
AWSでは、EBSを使用してストレージを追加することができる。
- コンパイル
人間がプログラムを書いたものを機械語に変換すること。
- 依存関係
Aツールを動かすには、Bツール、Cツールが必要みたいなこと。


# パッケージ管理システム(dnf)
yumが置き換わり、dnfが使われている。
==============================
# dnf install httpd
→ webサーバ(apache)のインストール
# dnf update
→ 全てのパッケージをアップデート
# dnf remove hpptd
→ webサーバ(apache)のアンインストール
# dnf list | grep postgresql
→ インストール済みのパッケージリストを確認
==============================


# ディストリビューション
ディストリビューション毎に使えるコマンドが異なる場合がある。
例）
AmazonLinux：dnf
ubuntu：apt


# システムの起動
1. 電源ONでBIOSが起動
2. BIOSからブートローダーが呼ばれる。
3. ブートローダーからカーネルが起動。
4. カーネル起動後、initプロセス(systemd)が実行される。


# systemd
systemctlコマンドを使って、プロセスを起動することができる。
root権限が必要。sudoの使用でも問題ない。
==============================
# サービスの起動
sudo systemctl start httpd
# サービスの停止
sudo systemctl stop httpd
# サービスの再起動
sudo systemctl restart httpd
# サービスの状態確認
sudo systemctl status httpd
# サービスの自動起動
sudo systemctl enable httpd
# サービスの自動起動かどうかの一覧
sudo systemctl is-enable httpd
==============================


# AWS Linux 接続情報
ssh -i ~/.ssh/CL_kurosawa.pem ec2-user@44.251.223.190


# バックグラウンド実行
==============================
# 末尾に「&」をつける。
less /etc/resolv.conf &

# バックグラウンド実行中処理の確認
jobs

# ターミナルを閉じたときにプロセスが終了するため、プロセスを終了させないために、nohupを使用。
nohup less /etc/resolv.conf &
==============================


# cron設定
crontab -e
*/1 * * * * sh /var/tmp/kurosawa.sh
==============================
分：0-59
時：0-23
日：1-31
月：1-12
曜日：0-7
0=日、1=月、2=火、3=水、4=木、5=金、6=土、7=日
==============================


# 演習
- cron-1
echo "echo Ohayo >> /home/ec2-user/31.log" > /var/tmp/Ohayo.sh

- cron-2
echo "echo Konnichiwa >> /home/ec2-user/32.log" > /var/tmp/Konnichiwa.sh

- cron-3
echo "echo Konbanwa >> /home/ec2-user/33.log" > /var/tmp/Konbanwa.sh

- cron-4
echo "echo OhaKonHelloChao >> /home/ec2-user/34.log" > /var/tmp/OhaKonHelloChao.sh

- cron設定
crontab -e
0,15,45 * * * * sh /var/tmp/Ohayo.sh
35 11 * * 3 sh /var/tmp/Konnichiwa.sh
35 11 14 1 * sh /var/tmp/Konbanwa.sh
*/10 * * * * sh /var/tmp/OhaKonHelloChao.sh



# 追加演習
- 演習1
sudo su -
adduser cronuser
exit
echo "mkdir -p ~/memo_dir && touch ~/memo_dir/memo.txt" > /var/tmp/tuika-1.sh
sudo crontab -u cronuser -e
0 15 * * 1-5 sh /var/tmp/tuika-1.sh


- 演習2
# 参考URL
https://qiita.com/sugichan55/items/219cb24b77d66f112b10


# 設定ファイルの作成
# /etc/systemd/system/cron.service
[Unit]
Description=Run tuika-2.sh script as ec2-user

[Service]
Type=oneshot
User=ec2-user
ExecStart=/usr/bin/sh /var/tmp/tuika-2.sh

[Install]
WantedBy=multi-user.target

# /etc/systemd/system/cron.timer
[Unit]
Description=Timer for tuika-2.sh Script

[Timer]
OnCalendar=*-*-* *:30:00
Persistent=true

[Install]
WantedBy=timers.target

# shファイル作成
echo "echo hogehoge >> /var/log/replace_cron.log" > /var/tmp/tuika-2.sh


# 設定の有効化
sudo systemctl enable cron.timer
sudo systemctl start cron.timer


# 起動確認
sudo systemctl is-enabled cron.timer
sudo systemctl status cron.timer





# ストレージ管理
1. EBSにストレージを追加する。
2. ストレージをアタッチする。
3. ストレージをマウントする。


アタッチ
仮想マシンのボリューム（データディスク）を追加（割り当て）する際に使用されます。

デタッチ
仮想マシンのボリューム（データディスク）を削除する際に使用されます。

パーティション






# EBS追加 & アタッチ
1. ナビゲーションの「ボリューム」を押下。「ボリュームの作成」を押下。
2. 以下を入力。以下以外はデフォルト
    サイズ (GiB)：最小を選択
    IOPS：最小を選択
    スループット (MiB/秒)：最小を選択
    アベイラビリティーゾーン：EC2インスタンスのアベイラビリティゾーンと合わせる
3. keyを追加する。（Name:CL_kurosawa）
3. ボリューム一覧から作成したボリュームを開く。
4. アクションの「ボリュームのアタッチ」を押下。
5. 以下を入力し、アタッチ。
    ・自身のEC2インスタンス（ボリューム作成時にEC2インスタンスのアベイラビリティゾーンを揃えること）
    ・デバイス名（選べるものを選択）


# ディスクマウント
6. ブロックを確認。（）
    lsblk
7. ファイルシステムの有無を確認。
    sudo file -s /dev/{nvme1n1}
    ※dataのみ表示される場合は、ファイルシステムが存在していない。
8. ファイルシステムを作成。
    sudo mkfs -t xfs /dev/{nvme1n1}
9. ファイルシステムが作成されたかを確認。
    sudo file -s /dev/{nvme1n1}
10. マウントポイントを作成。
    sudo mkdir /data
11. マウントポイントとディスクをマウントする。
    sudo mount /dev/{nvme1n1} /data
12. マウントポイントを確認。
    lsblk


# アンマウント
1. 状態を確認。
    lsblk
2. アンマウントする。
    sudo umount /dev/nvme1n1 /data
3. 新規マウントポイントを作成。
    sudo mkdir -p /saba/miso
4. マウントポイントとディスクをマウントする。
    sudo mount /dev/nvme1n1 /saba/miso


# 演習
lsblk
sudo file -s /dev/nvme2n1
sudo mkfs -t xfs /dev/nvme2n1
sudo file -s /dev/nvme2n1
sudo mkdir -p /home/sushi/tamago
sudo mount /dev/nvme2n1 /home/sushi/tamago
sudo lsblk -f

# マウントを恒久的にする方法
1. bk作成
sudo cp /etc/fstab /etc/fstab.orig

2. UUID確認
sudo lsblk -o +UUID

3. 設定変更
sudo vim /etc/fstab

4. ↓追加設定
UUID=a9a25622-aca8-4f00-8a4c-90e9348b90d0     /home/sushi/tamago       xfs    defaults,nofail   0   2

5. 動作確認
sudo umount /home/sushi/tamago
lsblk
sudo mount -a
lsblk



# 参考資料
- EBSボリュームの作成
https://docs.aws.amazon.com/ja_jp/ebs/latest/userguide/ebs-creating-volume.html

- EBSボリュームをEC2インスタンスにアタッチ
https://docs.aws.amazon.com/ja_jp/ebs/latest/userguide/ebs-attaching-volume.html

- Amazon EBS ボリュームを使用できるようにする
https://docs.aws.amazon.com/ja_jp/ebs/latest/userguide/ebs-using-volumes.html




# マウント
lsblk
Linuxシステムでブロックデバイス（HDD、SSD、USBメモリなど）とそのパーティション構成をツリー形式で一覧表示する。



# `◼️ ロードバランサーとは？`
ロードバランサー = 負荷分散装置

ALB = 「アプリケーションロードバランサー」の略

安定したサービスを提供するために必要経費として予算を割いている。

研修では「F5 BigIP」を使用。

ALBのロードバランサーは従量課金制。

<br>
<br>

## ロードバランサーを構成する要素
- ノード
    - サーバ一つ一つの単位

- pool
    - ノードの集まり

- 仮装IP
    - poolに割り当てられる仮装的なIPアドレス

</br>
</br>

## ヘルスチェック
アクセスを割り振る各サーバに定期的に通信を行い、サーバが正常に稼働しているかを判断します(死活監視)

</br>
</br>

## L4・L7バランシング
- L4ロードバランサー
    - IPアドレスやポート番号によって振り分けるもの
    - 80番ポートででアクセスできるか

- L7ロードバランサー
    - URLやパスによって振り分けるもの
    - ヘルスチェック用のURLへアクセスして、ステータスコード(200)が返ってくるか


DNSの運用コスト削減

DNSの宛先をALBのドメインに対し、割り振る。

</br>
</br>


## 振り分け方
- ラウンドロビン
    - 全てのサーバに均等に割り振る。
    - 基本この方式が一般的に使われている。

- リーストコネクション
    - 現在の接続数が最も少ないサーバへアクセスを振り分ける方法。

- 重み付け
    - 特定のサーバに多めにアクセスを振り分ける方法。
    - メンテナンス時に使われることが多い。

</br>
</br>

# `◼️ ALBとは`
AWSでもロードバランサーの導入が可能。
- ELB(ElasticLoadBalancer)
    - ALB(ApplicationLoadBalancer)
        - 基本これが使われる。
    - NLB(NetworkLoadBalancer)
        - あまり使われない。
    - GLB(GatewayLoadBalancer)
        - あまり使われない。


</br>
</br>
</br>


# `◼️ 演習手順`
## - ALB-1 -
**AWS上でロードバランサー用のセキュリティグループを作成します**

**AWS上でターゲットグループを作成します**

**AWS上でロードバランサーを作成します**

</br>
</br>

## - ALB-2 -
**ファイル作成**
```bash
sudo mkdir /var/www/html/saba
sudo vi /var/www/html/saba/saba.html
```

**リスナールールを追加**
```
ロードバランサー
↓
リスナーとルール
↓
チェック入れる
↓
ルールの編集
↓
ルールを追加する
↓
条件（パス）
↓
パスの条件値（/saba/*）
↓
アクション（ターゲットグループを追加）
↓
次へ
↓
優先度を追加
↓
次へ
↓
ルールを追加する
```
</br>
</br>

## - ALB-3 -
**ヘルスチェックのファイルを作成**
```bash
sudo touch /var/www/html/health
```

**Apacheの設定を変更**
```bash
sudo vi /etc/httpd/conf/httpd.conf
```

**▼修正**
```bash
CustomLog "logs/access_log" combined
↓
SetEnvIf User-Agent "ELB-HealthChecker" health_check
CustomLog "logs/access_log" combined env=!health_check
CustomLog "logs/healthcheck_log" combined env=health_check
```

**ログが作成できていることを確認**

▼ブラウザからのアクセス確認
```bash
sudo tail /etc/httpd/logs/access_log
```
```bash
172.31.42.126 - - [12/Feb/2026:08:05:14 +0000] "GET /saba/saba.html HTTP/1.1" 404 236 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36 Edg/144.0.0.0"
172.31.42.126 - - [12/Feb/2026:08:05:26 +0000] "GET /miso/miso.html HTTP/1.1" 304 - "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36 Edg/144.0.0.0"
172.31.42.126 - - [12/Feb/2026:08:05:41 +0000] "GET /saba/saba.html HTTP/1.1" 404 236 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36 Edg/144.0.0.0"
172.31.42.126 - - [12/Feb/2026:08:06:15 +0000] "GET /saba/saba.html HTTP/1.1" 404 236 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36 Edg/144.0.0.0"
172.31.42.126 - - [12/Feb/2026:08:37:00 +0000] "GET /saba/saba.html HTTP/1.1" 404 236 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36 Edg/144.0.0.0"
```

</br>

▼ヘルスチェックのアクセス確認
```bash
sudo tail /etc/httpd/logs/healthcheck_log
```
```bash
172.31.28.238 - - [12/Feb/2026:08:42:44 +0000] "GET /health HTTP/1.1" 200 5 "-" "ELB-HealthChecker/2.0"
172.31.42.126 - - [12/Feb/2026:08:42:55 +0000] "GET /health HTTP/1.1" 200 5 "-" "ELB-HealthChecker/2.0"
172.31.28.238 - - [12/Feb/2026:08:43:14 +0000] "GET /health HTTP/1.1" 200 5 "-" "ELB-HealthChecker/2.0"
172.31.42.126 - - [12/Feb/2026:08:43:25 +0000] "GET /health HTTP/1.1" 200 5 "-" "ELB-HealthChecker/2.0"
172.31.28.238 - - [12/Feb/2026:08:43:44 +0000] "GET /health HTTP/1.1" 200 5 "-" "ELB-HealthChecker/2.0"
172.31.42.126 - - [12/Feb/2026:08:43:55 +0000] "GET /health HTTP/1.1" 200 5 "-" "ELB-HealthChecker/2.0"
172.31.28.238 - - [12/Feb/2026:08:44:14 +0000] "GET /health HTTP/1.1" 200 5 "-" "ELB-HealthChecker/2.0"
```







